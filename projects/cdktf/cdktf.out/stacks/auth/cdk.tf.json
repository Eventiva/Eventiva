{
  "//": {
    "metadata": {
      "backend": "local",
      "stackName": "auth",
      "version": "0.20.8"
    },
    "outputs": {
    }
  },
  "data": {
    "terraform_remote_state": {
      "cross-stack-reference-input-aws": {
        "backend": "local",
        "config": {
          "path": "C:\\Users\\TGTGa\\WebstormProjects\\Eventiva\\projects\\cdktf\\terraform.aws.tfstate"
        },
        "workspace": "${terraform.workspace}"
      }
    }
  },
  "provider": {
    "kubernetes": [
      {
        "cluster_ca_certificate": "${data.terraform_remote_state.cross-stack-reference-input-aws.outputs.cross-stack-output-aws_eks_clusterekscertificate_authority0data}",
        "exec": [
          {
            "api_version": "client.authentication.k8s.io/v1beta1",
            "args": [
              "eks",
              "get-token",
              "--cluster-name",
              "${data.terraform_remote_state.cross-stack-reference-input-aws.outputs.cross-stack-output-aws_eks_clustereksname}"
            ],
            "command": "aws"
          }
        ],
        "host": "${data.terraform_remote_state.cross-stack-reference-input-aws.outputs.cross-stack-output-aws_eks_clustereksendpoint}"
      }
    ],
    "random": [
      {
      }
    ]
  },
  "resource": {
    "kubernetes_config_map": {
      "fusionauthConfigMap": {
        "//": {
          "metadata": {
            "path": "auth/fusionauthConfigMap",
            "uniqueId": "fusionauthConfigMap"
          }
        },
        "data": {
          "kickstart.json": "{\r\n  \"variables\": {\r\n    \"apiKey\": \"#{ENV.FUSIONAUTH_API_KEY}\",\r\n    \"defaultTenantId\": \"#{ENV.FUSIONAUTH_DEFAULT_TENANT}\",\r\n    \"adminEmail\": \"jonathan.stevens@eventiva.co.uk\",\r\n    \"adminPassword\": \"xge2vqt5xjt@KBM0dyq\",\r\n    \"adminUserId\": \"#{ENV.ADMIN_USER_ID}\"\r\n  },\r\n  \"apiKeys\": [\r\n    {\r\n      \"key\": \"#{apiKey}\"\r\n    }\r\n  ],\r\n  \"requests\": [\r\n    {\r\n      \"method\": \"POST\",\r\n      \"url\": \"/api/user/registration/#{adminUserId}\",\r\n      \"body\": {\r\n        \"user\": {\r\n          \"birthDate\": \"1989-06-03\",\r\n          \"email\": \"#{adminEmail}\",\r\n          \"firstName\": \"Jonathan\",\r\n          \"lastName\": \"Stevens\",\r\n          \"password\": \"#{adminPassword}\"\r\n        },\r\n        \"registration\": {\r\n          \"applicationId\": \"#{FUSIONAUTH_APPLICATION_ID}\",\r\n          \"roles\": [\r\n            \"admin\"\r\n          ]\r\n        }\r\n      }\r\n    }\r\n  ]\r\n}\r\n"
        },
        "metadata": {
          "name": "fusionauth-config",
          "namespace": "default"
        }
      }
    },
    "kubernetes_deployment": {
      "fusionauthDeployment": {
        "//": {
          "metadata": {
            "path": "auth/fusionauthDeployment",
            "uniqueId": "fusionauthDeployment"
          }
        },
        "metadata": {
          "name": "fusionauth",
          "namespace": "default"
        },
        "spec": {
          "replicas": "1",
          "selector": {
            "match_labels": {
              "app": "fusionauth"
            }
          },
          "template": {
            "metadata": {
              "labels": {
                "app": "fusionauth"
              }
            },
            "spec": {
              "container": [
                {
                  "env": [
                    {
                      "name": "DATABASE_URL",
                      "value": "jdbc:postgresql://postgres:5432/fusionauth"
                    },
                    {
                      "name": "DATABASE_ROOT_USERNAME",
                      "value": "${data.terraform_remote_state.cross-stack-reference-input-aws.outputs.cross-stack-output-varpostgres_user}"
                    },
                    {
                      "name": "DATABASE_ROOT_PASSWORD",
                      "value": "${data.terraform_remote_state.cross-stack-reference-input-aws.outputs.cross-stack-output-random_stringpostgres_passwordresult}"
                    },
                    {
                      "name": "DATABASE_USERNAME",
                      "value": "${var.database_username}"
                    },
                    {
                      "name": "DATABASE_PASSWORD",
                      "value": "${random_string.database_password.result}"
                    },
                    {
                      "name": "FUSIONAUTH_APP_MEMORY",
                      "value": "${var.fusionauthAppMemory}"
                    },
                    {
                      "name": "FUSIONAUTH_APP_RUNTIME_MODE",
                      "value": "${var.fusionauthAppRuntimeMode}"
                    },
                    {
                      "name": "FUSIONAUTH_APP_URL",
                      "value": "http://fusionauth:9011"
                    },
                    {
                      "name": "SEARCH_SERVERS",
                      "value": "http://opensearch:9200"
                    },
                    {
                      "name": "SEARCH_TYPE",
                      "value": "elasticsearch"
                    },
                    {
                      "name": "FUSIONAUTH_API_KEY",
                      "value": "${random_string.fusionauthApiKey.result}"
                    },
                    {
                      "name": "FUSIONAUTH_DEFAULT_TENANT",
                      "value": "${random_uuid.fusionauthDefaultTenant.result}"
                    },
                    {
                      "name": "FUSIONAUTH_APP_KICKSTART_FILE",
                      "value": "/usr/local/fusionauth/kickstart/kickstart.json"
                    },
                    {
                      "name": "ADMIN_USER_ID",
                      "value": "${random_uuid.fusionAdminUserId.result}"
                    }
                  ],
                  "image": "fusionauth/fusionauth-app:latest",
                  "name": "fusionauth",
                  "port": [
                    {
                      "container_port": 9011
                    }
                  ],
                  "volume_mount": [
                    {
                      "mount_path": "/usr/local/fusionauth/kickstart/",
                      "name": "fusionauth-config"
                    }
                  ]
                }
              ],
              "init_container": [
                {
                  "command": [
                    "sh",
                    "-c",
                    "until nc -z postgres 5432; do echo waiting for postgres; sleep 2; done;"
                  ],
                  "image": "busybox",
                  "name": "init-postgres"
                },
                {
                  "command": [
                    "sh",
                    "-c",
                    "until nc -z opensearch 9200; do echo waiting for opensearch; sleep 2; done;"
                  ],
                  "image": "busybox",
                  "name": "init-opensearch"
                }
              ],
              "volume": [
                {
                  "config_map": {
                    "name": "${kubernetes_config_map.fusionauthConfigMap.metadata[0].name}"
                  },
                  "name": "fusionauth-config"
                }
              ]
            }
          }
        }
      },
      "openSearchDeployment": {
        "//": {
          "metadata": {
            "path": "auth/openSearchDeployment",
            "uniqueId": "openSearchDeployment"
          }
        },
        "metadata": {
          "name": "opensearch",
          "namespace": "default"
        },
        "spec": {
          "replicas": "1",
          "selector": {
            "match_labels": {
              "app": "opensearch"
            }
          },
          "template": {
            "metadata": {
              "labels": {
                "app": "opensearch"
              }
            },
            "spec": {
              "container": [
                {
                  "env": [
                    {
                      "name": "cluster.name",
                      "value": "fusionauth"
                    },
                    {
                      "name": "discovery.type",
                      "value": "single-node"
                    },
                    {
                      "name": "node.name",
                      "value": "search"
                    },
                    {
                      "name": "plugins.security.disabled",
                      "value": "true"
                    },
                    {
                      "name": "bootstrap.memory_lock",
                      "value": "true"
                    },
                    {
                      "name": "OPENSEARCH_JAVA_OPTS",
                      "value": "-Xms512m -Xmx512m"
                    }
                  ],
                  "image": "opensearchproject/opensearch:2.11.0",
                  "name": "opensearch",
                  "port": [
                    {
                      "container_port": 9200
                    }
                  ],
                  "volume_mount": [
                    {
                      "mount_path": "/usr/share/opensearch/data",
                      "name": "opensearch-storage"
                    }
                  ]
                }
              ],
              "volume": [
                {
                  "name": "opensearch-storage",
                  "persistent_volume_claim": {
                    "claim_name": "${kubernetes_persistent_volume_claim.opensearchPersistentVolumeClaim.metadata[0].name}"
                  }
                }
              ]
            }
          }
        }
      },
      "permifyDeployment": {
        "//": {
          "metadata": {
            "path": "auth/permifyDeployment",
            "uniqueId": "permifyDeployment"
          }
        },
        "metadata": {
          "name": "permify",
          "namespace": "default"
        },
        "spec": {
          "replicas": "1",
          "selector": {
            "match_labels": {
              "app": "permify"
            }
          },
          "strategy": {
            "type": "Recreate"
          },
          "template": {
            "metadata": {
              "labels": {
                "app": "permify"
              }
            },
            "spec": {
              "container": [
                {
                  "env": [
                    {
                      "name": "PERMIFY_ACCOUNT_ID",
                      "value": "recASPn1X1pGJauXB"
                    }
                  ],
                  "image": "ghcr.io/permify/permify",
                  "name": "permify",
                  "port": [
                    {
                      "container_port": 3476
                    }
                  ]
                }
              ],
              "restart_policy": "Always"
            }
          }
        }
      }
    },
    "kubernetes_persistent_volume_claim": {
      "opensearchPersistentVolumeClaim": {
        "//": {
          "metadata": {
            "path": "auth/opensearchPersistentVolumeClaim",
            "uniqueId": "opensearchPersistentVolumeClaim"
          }
        },
        "metadata": {
          "name": "opensearch-pvc"
        },
        "spec": {
          "access_modes": [
            "ReadWriteOnce"
          ],
          "resources": {
            "requests": {
              "storage": "10Gi"
            }
          }
        }
      }
    },
    "kubernetes_service": {
      "fusionauthService": {
        "//": {
          "metadata": {
            "path": "auth/fusionauthService",
            "uniqueId": "fusionauthService"
          }
        },
        "metadata": {
          "name": "fusionauth",
          "namespace": "default"
        },
        "spec": {
          "port": [
            {
              "port": 9011,
              "target_port": "9011"
            }
          ],
          "selector": {
            "app": "fusionauth"
          },
          "type": "LoadBalancer"
        }
      },
      "openSearchService": {
        "//": {
          "metadata": {
            "path": "auth/openSearchService",
            "uniqueId": "openSearchService"
          }
        },
        "metadata": {
          "name": "opensearch",
          "namespace": "default"
        },
        "spec": {
          "port": [
            {
              "port": 9200,
              "target_port": "9200"
            }
          ],
          "selector": {
            "app": "opensearch"
          }
        }
      },
      "permifyService": {
        "//": {
          "metadata": {
            "path": "auth/permifyService",
            "uniqueId": "permifyService"
          }
        },
        "metadata": {
          "name": "permify",
          "namespace": "default"
        },
        "spec": {
          "port": [
            {
              "port": 3476,
              "protocol": "TCP",
              "target_port": "3476"
            }
          ],
          "selector": {
            "app": "permify"
          },
          "type": "LoadBalancer"
        }
      }
    },
    "random_string": {
      "database_password": {
        "//": {
          "metadata": {
            "path": "auth/database_password",
            "uniqueId": "database_password"
          }
        },
        "length": 20
      },
      "fusionauthApiKey": {
        "//": {
          "metadata": {
            "path": "auth/fusionauthApiKey",
            "uniqueId": "fusionauthApiKey"
          }
        },
        "length": 20,
        "special": false
      }
    },
    "random_uuid": {
      "fusionAdminUserId": {
        "//": {
          "metadata": {
            "path": "auth/fusionAdminUserId",
            "uniqueId": "fusionAdminUserId"
          }
        }
      },
      "fusionauthDefaultTenant": {
        "//": {
          "metadata": {
            "path": "auth/fusionauthDefaultTenant",
            "uniqueId": "fusionauthDefaultTenant"
          }
        }
      }
    }
  },
  "terraform": {
    "backend": {
      "local": {
        "path": "C:\\Users\\TGTGa\\WebstormProjects\\Eventiva\\projects\\cdktf\\terraform.auth.tfstate"
      }
    },
    "required_providers": {
      "kubernetes": {
        "source": "kubernetes",
        "version": "2.32.0"
      },
      "random": {
        "source": "hashicorp/random",
        "version": "3.6.2"
      }
    }
  },
  "variable": {
    "database_username": {
      "default": "fusionauth",
      "type": "string"
    },
    "fusionauthAppMemory": {
      "default": "512M",
      "type": "string"
    },
    "fusionauthAppRuntimeMode": {
      "default": "development",
      "type": "string"
    }
  }
}